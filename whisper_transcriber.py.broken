#!/usr/bin/env python3
"""
Whisper + Claude Code éŸ³å£°è¨˜äº‹åŒ–ã‚·ã‚¹ãƒ†ãƒ 
APIã‚³ã‚¹ãƒˆã‚¼ãƒ­ãƒ»ãƒ­ãƒ¼ã‚«ãƒ«æ–‡å­—èµ·ã“ã—å¯¾å¿œ
"""

import os
import sys
import argparse
import tempfile
import subprocess
from pathlib import Path
import whisper
from dotenv import load_dotenv
import re
import pyperclip

# ç’°å¢ƒå¤‰æ•°ã®èª­ã¿è¾¼ã¿
load_dotenv()

class WhisperTranscriber:
    def __init__(self):
        # Whisperãƒ¢ãƒ‡ãƒ«ã®åˆæœŸåŒ–
        self.model = None
        self.model_name = "base"  # base, small, medium, large ã‹ã‚‰é¸æŠå¯èƒ½
        
        # æ–‡ä½“å­¦ç¿’ç”¨ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹
        self.style_file_path = "/Users/manami/(N)noteæœ¬æ–‡.md"
        
        # æ–‡ä½“ã‚µãƒ³ãƒ—ãƒ«ã‚’èª­ã¿è¾¼ã¿
        self.style_text = self.load_style_sample()
        
        # å‡¦ç†ãƒ•ã‚¡ã‚¤ãƒ«ã®ç®¡ç†
        self.current_audio_name = None
        
        # æ–‡ç« æ•´ç†æ©Ÿèƒ½ã®åˆæœŸåŒ–
        pass

    def cleanup_previous_files(self):
        """å‰å›ã®å‡¦ç†ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®Œå…¨ã‚¯ãƒªã‚¢ã™ã‚‹"""
        try:
            current_dir = Path.cwd()
            cleanup_count = 0
            
            # å‰å›ã®æ–‡å­—èµ·ã“ã—ãƒ»è¨˜äº‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
            for file_path in current_dir.glob('*'):
                if file_path.is_file():
                    # å‡¦ç†ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
                    if any(pattern in file_path.name for pattern in [
                        '_transcript.txt', '_article.txt', 
                        'temp', 'tmp', '.whisper', '.cache'
                    ]) and file_path.suffix in ['.txt', '.wav', '.mp3', '.cache']:
                        file_path.unlink()
                        cleanup_count += 1
            
            # ãƒ¡ãƒ¢ãƒªä¸Šã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
            if hasattr(self, 'model') and self.model:
                # Whisperãƒ¢ãƒ‡ãƒ«ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ï¼ˆãƒ¡ãƒ¢ãƒªç¯€ç´„ï¼‰
                pass  # Whisperãƒ¢ãƒ‡ãƒ«è‡ªä½“ã¯ä¿æŒã—ã¦å†åˆ©ç”¨ã™ã‚‹
            
            if cleanup_count > 0:
                print(f"ğŸ§¹ å‰å›ã®å‡¦ç†ãƒ•ã‚¡ã‚¤ãƒ« {cleanup_count}å€‹ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ")
            
        except Exception as e:
            print(f"âš ï¸ ãƒ•ã‚¡ã‚¤ãƒ«ã‚¯ãƒªã‚¢ä¸­ã«ã‚¨ãƒ©ãƒ¼: {e}")

    def load_whisper_model(self):
        """Whisperãƒ¢ãƒ‡ãƒ«ã‚’èª­ã¿è¾¼ã¿"""
        if self.model is None:
            print(f"ğŸ¤– Whisperãƒ¢ãƒ‡ãƒ« ({self.model_name}) ã‚’èª­ã¿è¾¼ã¿ä¸­...")
            try:
                self.model = whisper.load_model(self.model_name)
                print("âœ… Whisperãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿å®Œäº†")
            except Exception as e:
                print(f"âŒ Whisperãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: {e}")
                sys.exit(1)

    def load_style_sample(self) -> str:
        """æ–‡ä½“ã‚µãƒ³ãƒ—ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿"""
        try:
            if os.path.exists(self.style_file_path):
                with open(self.style_file_path, 'r', encoding='utf-8') as f:
                    content = f.read()
                    # æœ€åˆã®50è¡Œç¨‹åº¦ã®æ–‡ä½“ã‚µãƒ³ãƒ—ãƒ«ã‚’æŠ½å‡º
                    lines = content.split('\n')
                    sample_lines = []
                    
                    for line in lines:
                        if line.strip() and not line.startswith('(') and not line.startswith('2025/'):
                            sample_lines.append(line)
                            if len(sample_lines) >= 50:
                                break
                    
                    return '\n'.join(sample_lines)
            else:
                # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ–‡ä½“
                return """ãƒãƒŠãƒŸã§ã™ã€‚

ä»Šå›ã¯ã€ŒSNSé‹ç”¨ã§ç–²ã‚ŒãŸæ™‚ã®å¯¾å‡¦æ³•ã€ã«ã¤ã„ã¦è©±ã—ã¾ã™ã€‚

SNSã‚’å§‹ã‚ãŸã°ã‹ã‚Šã®é ƒã¯ã€æ¯æ—¥æŠ•ç¨¿ã™ã‚‹ã“ã¨ã‚„ã€Œã„ã„ã­ã€ã®æ•°ã‚’æ°—ã«ã—ã¦ã—ã¾ã„ãŒã¡ã§ã™ã€‚ã§ã‚‚ã€ãã‚“ãªé¢¨ã«é ‘å¼µã‚Šã™ãã¦ã„ã‚‹ã¨ã€ã ã‚“ã ã‚“ç–²ã‚Œã¦ãã¦ã—ã¾ã†ã‚“ã§ã™ã‚ˆã­ã€‚

ç§ã‚‚æœ€åˆã®é ƒã¯ã€æ¯æ—¥ä½•ã‹ã‚’æŠ•ç¨¿ã—ãªã‘ã‚Œã°ã„ã‘ãªã„ã¨æ€ã£ã¦ã„ã¾ã—ãŸã€‚ã§ã‚‚ã€ãã‚Œã£ã¦ã™ã”ãå¤§å¤‰ãªã“ã¨ãªã‚“ã§ã™ã€‚æ¯æ—¥ãƒã‚¿ã‚’è€ƒãˆã¦ã€å†™çœŸã‚’æ’®ã£ã¦ã€æ–‡ç« ã‚’æ›¸ã„ã¦...ã€‚æ°—ãŒã¤ãã¨ã€SNSã®ã“ã¨ã°ã‹ã‚Šè€ƒãˆã¦ã„ã‚‹è‡ªåˆ†ãŒã„ã¾ã—ãŸã€‚

ãã‚“ãªæ™‚ã«å¤§åˆ‡ãªã®ã¯ã€Œç„¡ç†ã‚’ã—ãªã„ã“ã¨ã€ã§ã™ã€‚æŠ•ç¨¿ã®é »åº¦ã‚’ä¸‹ã’ã¦ã‚‚å¤§ä¸ˆå¤«ã§ã™ã—ã€ãŸã¾ã«ã¯ä¼‘ã‚“ã§ã‚‚æ§‹ã„ã¾ã›ã‚“ã€‚ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ã®æ–¹ã€…ã¯ã€ã‚ãªãŸãŒç„¡ç†ã‚’ã—ã¦ã„ã‚‹ã“ã¨ã‚ˆã‚Šã‚‚ã€è‡ªç„¶ä½“ã§ã„ã‚‹ã“ã¨ã‚’æœ›ã‚“ã§ã„ã‚‹ã¯ãšã§ã™ã€‚"""
        except Exception as e:
            print(f"âŒ æ–‡ä½“ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: {e}")
            return "ãƒãƒŠãƒŸã§ã™ã€‚\n\nä»Šå›ã¯éŸ³å£°é…ä¿¡ã®å†…å®¹ã«ã¤ã„ã¦è©±ã—ã¾ã™ã€‚"

    def clean_transcript(self, transcript: str) -> str:
        """æ–‡å­—èµ·ã“ã—ãƒ†ã‚­ã‚¹ãƒˆã‚’æ•´ç†"""
        # éŸ³éŸ»è»¢æ›ã‚„æ˜ã‚‰ã‹ãªèª¤èªè­˜ã‚’ä¿®æ­£
        corrections = {
            'å­¦ã¿': 'ãƒãƒŠãƒŸ',
            'SNAæŒ‡ã—': 'SNSç™ºä¿¡',
            'ã‚µãƒ‹ãƒ¼': '3äºº',
            'ãƒ•ã‚£ãƒ©ã‚¹': 'ãƒ•ãƒªãƒ¼ãƒ©ãƒ³ã‚¹',
            'ã‚¯ãƒ©ã‚¤ãƒ–é€šã‚Š': 'ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ',
            'ãƒ†ãƒ¼ãƒ‘ãƒ³': 'ãƒ—ãƒ©ãƒ³',
            'ã©ã†ã™ã”ã™': 'ã©ã†éã”ã™',
            'ã¨ã‚Šã‚ãˆãš': '',  # å†—é•·ãªå ´åˆã¯å‰Šé™¤
            'ãã‚Œã§': '',     # æ–‡é ­ã®ä¸è¦ãªæ¥ç¶šè©
            'ã¾ã': '',       # å£ç™–çš„ãªè¡¨ç¾
            'ãã†ã§ã™ã­': '',  # è©±ã—è¨€è‘‰ã®ç™–
            'ãˆã£ã¨': '',     # é–“ã¤ãªãã®è¨€è‘‰
            'ã‚ã®': '',       # é–“ã¤ãªãã®è¨€è‘‰
            'ãˆãƒ¼': '',       # é–“ã¤ãªãã®è¨€è‘‰
            'ã†ãƒ¼ã‚“': '',     # è€ƒãˆè¾¼ã‚€éŸ³
            'ãªã‚“ã‹': '',     # å†—é•·ãªè¡¨ç¾
        }
        
        # æ–‡å­—èµ·ã“ã—ã‚¨ãƒ©ãƒ¼ã®ä¿®æ­£
        text = transcript
        for wrong, correct in corrections.items():
            text = text.replace(wrong, correct)
        
        # é‡è¤‡ã™ã‚‹æ¥ç¶šè©ã‚„å†—é•·ãªè¡¨ç¾ã‚’å‰Šé™¤
        text = re.sub(r'\s+', ' ', text)  # ä½™åˆ†ãªç©ºç™½å‰Šé™¤
        text = re.sub(r'ãã†(ãã†)+', 'ãã†', text)  # é‡è¤‡å‰Šé™¤
        text = re.sub(r'ã§ã§+', 'ã§', text)  # é‡è¤‡å‰Šé™¤
        
        return text.strip()
    
    def organize_content(self, transcript: str) -> str:
        """æ–‡å­—èµ·ã“ã—å†…å®¹ã‚’è¨˜äº‹ã¨ã—ã¦æ•´ç†"""
        cleaned_text = self.clean_transcript(transcript)
        
        # å®Ÿéš›ã®æ–‡å­—èµ·ã“ã—å†…å®¹ã‚’ä½¿ç”¨ã—ã¦è¨˜äº‹ã‚’ä½œæˆ
        article = "ãƒãƒŠãƒŸã§ã™ã€‚\n\n"
        
        # æ–‡å­—èµ·ã“ã—ã‚’æ®µè½ã”ã¨ã«åˆ†å‰²ã—ã¦æ•´ç†
        sentences = cleaned_text.split('ã€‚')
        current_paragraph = ""
        
        for sentence in sentences:
            sentence = sentence.strip()
            if not sentence:
                continue
                
            # æ–‡ã®é•·ã•ã§æ®µè½ã‚’åˆ†ã‘ã‚‹
            if len(current_paragraph + sentence) > 150:  # 150æ–‡å­—ã§æ®µè½åŒºåˆ‡ã‚Š
                if current_paragraph:
                    article += current_paragraph.strip() + "ã€‚\n\n"
                    current_paragraph = sentence + "ã€‚"
                else:
                    current_paragraph = sentence + "ã€‚"
            else:
                current_paragraph += sentence + "ã€‚"
        
        # æœ€å¾Œã®æ®µè½ã‚’è¿½åŠ 
        if current_paragraph:
            article += current_paragraph.strip() + "ã€‚\n\n"
        
        # çµã³ã®æ–‡ã‚’è¿½åŠ 
        if not article.strip().endswith('ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚'):
            article += "ä»Šæ—¥ã‚‚èª­ã‚“ã§ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚"
        
        return article
    
    def adjust_length(self, text: str, target_length: int = 2000) -> str:
        """æ–‡å­—æ•°ã‚’èª¿æ•´"""
        current_length = len(text)
        
        # 2000æ–‡å­—ç›®æ¨™ãªã®ã§ã€çŸ­ã„å ´åˆã¯è¿½åŠ ã€é•·ã„å ´åˆã¯èª¿æ•´
        if current_length > target_length * 1.2:  # 2400æ–‡å­—ã‚’è¶…ãˆã‚‹å ´åˆã®ã¿çŸ­ç¸®
            sentences = text.split('ã€‚')
            result = ''
            for sentence in sentences:
                if len(result + sentence + 'ã€‚') <= target_length:
                    result += sentence + 'ã€‚'
                else:
                    break
            return result.rstrip('ã€‚') + 'ã€‚'
        
        # åŸºæœ¬çš„ã«ã¯ç”Ÿæˆã•ã‚ŒãŸæ–‡ç« ã‚’ãã®ã¾ã¾ä½¿ç”¨
        return text

    def print_banner(self):
        """ãƒãƒŠãƒ¼è¡¨ç¤º"""
        print("ğŸ™ï¸" + "="*60)
        print("    Whisper + Claude Code éŸ³å£°è¨˜äº‹åŒ–ã‚·ã‚¹ãƒ†ãƒ ")
        print("    ğŸ’° APIã‚³ã‚¹ãƒˆã‚¼ãƒ­ãƒ»ãƒ­ãƒ¼ã‚«ãƒ«å‡¦ç†å¯¾å¿œ")
        print("="*62)
        
        # æ–‡ä½“å­¦ç¿’çŠ¶æ³ã‚’è¡¨ç¤º
        if os.path.exists(self.style_file_path):
            print("âœ… æ–‡ä½“å­¦ç¿’æ¸ˆã¿: noteæœ¬æ–‡.mdã‹ã‚‰æ–‡ä½“ã‚’å­¦ç¿’")
        else:
            print("âš ï¸ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ–‡ä½“ã‚’ä½¿ç”¨")
        print()

    def convert_audio_format(self, input_path: str, output_path: str) -> bool:
        """éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’WAVã«å¤‰æ›"""
        try:
            cmd = [
                'ffmpeg', '-i', input_path, '-acodec', 'pcm_s16le', 
                '-ar', '16000', '-ac', '1', output_path, '-y'
            ]
            result = subprocess.run(cmd, capture_output=True, text=True)
            return result.returncode == 0
        except Exception as e:
            print(f"âŒ éŸ³å£°å¤‰æ›ã‚¨ãƒ©ãƒ¼: {e}")
            return False

    def transcribe_with_whisper(self, audio_path: str) -> str:
        """Whisperã«ã‚ˆã‚‹éŸ³å£°æ–‡å­—èµ·ã“ã—"""
        try:
            self.load_whisper_model()
            print("ğŸ—£ï¸ Whisperã§æ–‡å­—èµ·ã“ã—ä¸­...")
            
            result = self.model.transcribe(audio_path, language="ja")
            transcript = result["text"]
            
            print(f"âœ… æ–‡å­—èµ·ã“ã—å®Œäº† ({len(transcript)}æ–‡å­—)")
            return transcript
            
        except Exception as e:
            print(f"âŒ Whisperæ–‡å­—èµ·ã“ã—ã‚¨ãƒ©ãƒ¼: {e}")
            return None
        
        # æ–‡ä½“å­¦ç¿’çŠ¶æ³ã‚’è¡¨ç¤º
        if os.path.exists(self.style_file_path):
            print("âœ… æ–‡ä½“å­¦ç¿’æ¸ˆã¿: noteæœ¬æ–‡.mdã‹ã‚‰æ–‡ä½“ã‚’å­¦ç¿’")
        else:
            print("âš ï¸ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ–‡ä½“ã‚’ä½¿ç”¨")
        print()

    def convert_audio_format(self, input_path: str, output_path: str) -> bool:
        """éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’WAVã«å¤‰æ›"""
        try:
            cmd = [
                'ffmpeg', '-i', input_path, '-acodec', 'pcm_s16le', 
                '-ar', '16000', '-ac', '1', output_path, '-y'
            ]
            result = subprocess.run(cmd, capture_output=True, text=True)
            return result.returncode == 0
        except Exception as e:
            print(f"âŒ éŸ³å£°å¤‰æ›ã‚¨ãƒ©ãƒ¼: {e}")
            return False

    def transcribe_with_whisper(self, audio_path: str) -> str:
        """Whisperã«ã‚ˆã‚‹éŸ³å£°æ–‡å­—èµ·ã“ã—"""
        try:
            self.load_whisper_model()
            print("ğŸ—£ï¸ Whisperã§æ–‡å­—èµ·ã“ã—ä¸­...")
            
            result = self.model.transcribe(audio_path, language="ja")
            transcript = result["text"]
            
            print(f"âœ… æ–‡å­—èµ·ã“ã—å®Œäº† ({len(transcript)}æ–‡å­—)")
            return transcript
            
        except Exception as e:
            print(f"âŒ Whisperæ–‡å­—èµ·ã“ã—ã‚¨ãƒ©ãƒ¼: {e}")
            return None

    def process_transcript_to_article(self, transcript: str) -> str:
        """æ–‡å­—èµ·ã“ã—ã‚’è¨˜äº‹ã«å¤‰æ›"""
        try:
            print("ğŸ”„ æ–‡å­—èµ·ã“ã—ã‚’è¨˜äº‹ã¨ã—ã¦æ•´ç†ä¸­...")
            
            # æ–‡ç« æ•´ç†å‡¦ç†
            organized_content = self.organize_content(transcript)
            
            # æ–‡å­—æ•°èª¿æ•´
            final_article = self.adjust_length(organized_content, 2000)
            
            print(f"âœ… è¨˜äº‹æ•´ç†å®Œäº† ({len(final_article)}æ–‡å­—)")
            return final_article
            
        except Exception as e:
            print(f"âŒ è¨˜äº‹æ•´ç†ã‚¨ãƒ©ãƒ¼: {e}")
            return None

    def save_results(self, transcript: str, article: str, filename: str):
        """çµæœã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜"""
        timestamp = Path(filename).stem
        
        # æ–‡å­—èµ·ã“ã—çµæœã‚’ä¿å­˜
        transcript_file = f"{timestamp}_transcript.txt"
        with open(transcript_file, 'w', encoding='utf-8') as f:
            f.write(transcript)
        
        # å®Œæˆè¨˜äº‹ã‚’ä¿å­˜
        article_file = f"{timestamp}_article.txt"
        with open(article_file, 'w', encoding='utf-8') as f:
            f.write(article)
        
        return transcript_file, article_file

    def display_results(self, transcript: str, article: str, filename: str):
        """çµæœã‚’è¡¨ç¤º"""
        print("\n" + "="*80)
        print("âœ¨ è¨˜äº‹ä½œæˆå®Œäº†ï¼")
        print("="*80)
        print(f"ğŸ“ å…ƒãƒ•ã‚¡ã‚¤ãƒ«: {filename}")
        print(f"ğŸ“ æ–‡å­—èµ·ã“ã—æ–‡å­—æ•°: {len(transcript)}æ–‡å­—")
        if article:
            print(f"ğŸ“° å®Œæˆè¨˜äº‹æ–‡å­—æ•°: {len(article)}æ–‡å­—")
        print("="*80)
        
        if article:
            print("\nğŸ“° å®Œæˆè¨˜äº‹:")
            print("-" * 80)
            print(article)
            print("-" * 80)
            
            # ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
            try:
                pyperclip.copy(article)
                print("\nğŸ“‹ è¨˜äº‹ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼")
            except Exception as e:
                print(f"âš ï¸ ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‚³ãƒ”ãƒ¼ã«å¤±æ•—: {e}")
        else:
            print("\nâŒ è¨˜äº‹ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ")
            print("\nğŸ“„ å…ƒã®æ–‡å­—èµ·ã“ã—çµæœ:")
            print("-" * 40)
            print(transcript)
        
        # ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³
        save_option = input("\nğŸ’¾ çµæœã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ (y/N): ").lower().strip()
        if save_option in ['y', 'yes']:
            try:
                if article:
                    transcript_file, article_file = self.save_results(transcript, article, filename)
                    print(f"âœ… æ–‡å­—èµ·ã“ã—: {transcript_file}")
                    print(f"âœ… å®Œæˆè¨˜äº‹: {article_file}")
                else:
                    timestamp = Path(filename).stem
                    transcript_file = f"{timestamp}_transcript.txt"
                    with open(transcript_file, 'w', encoding='utf-8') as f:
                        f.write(transcript)
                    print(f"âœ… æ–‡å­—èµ·ã“ã—: {transcript_file}")
            except Exception as e:
                print(f"âŒ ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: {e}")

    def process_audio_file(self, audio_path: str):
        """éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®å‡¦ç†ãƒ¡ã‚¤ãƒ³"""
        try:
            filename = Path(audio_path).name
            
            # æ–°ã—ã„éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®å‡¦ç†é–‹å§‹æ™‚ã«å‰å›ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªã‚¢
            if self.current_audio_name != filename:
                print(f"ğŸ†• æ–°ã—ã„éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œå‡º: {filename}")
                self.cleanup_previous_files()
                self.current_audio_name = filename
            
            print(f"ğŸµ å‡¦ç†é–‹å§‹: {filename}")
            
            # éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›
            wav_path = None
            file_ext = Path(audio_path).suffix.lower()
            
            if file_ext != '.wav':
                print("ğŸ”„ éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¤‰æ›ä¸­...")
                with tempfile.NamedTemporaryFile(suffix='.wav', delete=False) as temp_wav:
                    wav_path = temp_wav.name
                
                if not self.convert_audio_format(audio_path, wav_path):
                    print("âš ï¸ éŸ³å£°å¤‰æ›ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å…ƒãƒ•ã‚¡ã‚¤ãƒ«ã§è©¦è¡Œã—ã¾ã™ã€‚")
                    wav_path = audio_path
            else:
                wav_path = audio_path
            
            # Whisperã§æ–‡å­—èµ·ã“ã—
            transcript = self.transcribe_with_whisper(wav_path)
            
            if not transcript:
                print("âŒ æ–‡å­—èµ·ã“ã—ã«å¤±æ•—ã—ã¾ã—ãŸ")
                return
            
            # è¨˜äº‹ã¨ã—ã¦æ•´ç†
            article = self.process_transcript_to_article(transcript)
            
            # çµæœè¡¨ç¤º
            self.display_results(transcript, article, filename)
            
        except Exception as e:
            print(f"âŒ å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
        finally:
            # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã®å®Œå…¨å‰Šé™¤
            try:
                if wav_path and wav_path != audio_path and os.path.exists(wav_path):
                    os.remove(wav_path)
            except Exception as e:
                print(f"âš ï¸ ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤ã‚¨ãƒ©ãƒ¼: {e}")
            
            # ãƒ¡ãƒ¢ãƒªä¸Šã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
            transcript = None
            wav_path = None
            article = None

def main():
    transcriber = WhisperTranscriber()
    transcriber.print_banner()
    
    parser = argparse.ArgumentParser(description="WhisperéŸ³å£°æ–‡å­—èµ·ã“ã— + Claude Codeè¨˜äº‹ç”Ÿæˆ")
    parser.add_argument("audio_file", nargs="?", help="éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹")
    parser.add_argument("--model", default="base", choices=["tiny", "base", "small", "medium", "large"],
                       help="ä½¿ç”¨ã™ã‚‹Whisperãƒ¢ãƒ‡ãƒ« (default: base)")
    
    args = parser.parse_args()
    
    if args.model:
        transcriber.model_name = args.model
    
    if args.audio_file:
        # ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ã‹ã‚‰
        if not os.path.exists(args.audio_file):
            print("âŒ ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:", args.audio_file)
            return
        
        transcriber.process_audio_file(args.audio_file)
    else:
        # ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãƒ¢ãƒ¼ãƒ‰
        print("ğŸ’¡ ä½¿ç”¨æ–¹æ³•:")
        print("   1. ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—")
        print("   2. ã¾ãŸã¯ã‚³ãƒãƒ³ãƒ‰: python whisper_transcriber.py [éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹]")
        print("   3. ã‚ªãƒ—ã‚·ãƒ§ãƒ³: --model [tiny/base/small/medium/large]")
        print()
        
        while True:
            try:
                file_path = input("ğŸ™ï¸ éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã‚’å…¥åŠ› (ã¾ãŸã¯ 'q' ã§çµ‚äº†): ").strip()
                
                if file_path.lower() == 'q':
                    break
                
                # ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—æ™‚ã®å¼•ç”¨ç¬¦ã‚’å‰Šé™¤
                file_path = file_path.strip('"').strip("'")
                
                if not os.path.exists(file_path):
                    print("âŒ ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
                    continue
                
                transcriber.process_audio_file(file_path)
                
                # ç¶šè¡Œç¢ºèª
                continue_option = input("\nğŸ”„ åˆ¥ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†ã—ã¾ã™ã‹ï¼Ÿ (y/N): ").lower().strip()
                if continue_option not in ['y', 'yes']:
                    break
                
            except KeyboardInterrupt:
                print("\nğŸ‘‹ çµ‚äº†ã—ã¾ã™")
                break
            except Exception as e:
                print(f"âŒ ã‚¨ãƒ©ãƒ¼: {e}")

if __name__ == "__main__":
    main()