#!/usr/bin/env python3
"""
Whisper + Claude Code éŸ³å£°è¨˜äº‹åŒ–ã‚·ã‚¹ãƒ†ãƒ 
APIã‚³ã‚¹ãƒˆã‚¼ãƒ­ãƒ»ãƒ­ãƒ¼ã‚«ãƒ«æ–‡å­—èµ·ã“ã—å¯¾å¿œ
"""

import os
import sys
import argparse
import tempfile
import subprocess
from pathlib import Path
import whisper
from dotenv import load_dotenv
import anthropic
import pyperclip

# ç’°å¢ƒå¤‰æ•°ã®èª­ã¿è¾¼ã¿
load_dotenv()

class WhisperTranscriber:
    def __init__(self):
        # Whisperãƒ¢ãƒ‡ãƒ«ã®åˆæœŸåŒ–
        self.model = None
        self.model_name = "base"  # base, small, medium, large ã‹ã‚‰é¸æŠå¯èƒ½
        
        # æ–‡ä½“å­¦ç¿’ç”¨ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹
        self.style_file_path = "/Users/manami/(N)noteæœ¬æ–‡.md"
        
        # æ–‡ä½“ã‚µãƒ³ãƒ—ãƒ«ã‚’èª­ã¿è¾¼ã¿
        self.style_text = self.load_style_sample()
        
        # Claude API ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–
        self.claude_client = None
        self.init_claude_client()
        
        # æ–‡ç« æ•´ç†ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
        self.article_prompt_template = self.create_article_prompt_template()

    def load_whisper_model(self):
        """Whisperãƒ¢ãƒ‡ãƒ«ã‚’èª­ã¿è¾¼ã¿"""
        if self.model is None:
            print(f"ğŸ¤– Whisperãƒ¢ãƒ‡ãƒ« ({self.model_name}) ã‚’èª­ã¿è¾¼ã¿ä¸­...")
            try:
                self.model = whisper.load_model(self.model_name)
                print("âœ… Whisperãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿å®Œäº†")
            except Exception as e:
                print(f"âŒ Whisperãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: {e}")
                sys.exit(1)

    def load_style_sample(self) -> str:
        """æ–‡ä½“ã‚µãƒ³ãƒ—ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿"""
        try:
            if os.path.exists(self.style_file_path):
                with open(self.style_file_path, 'r', encoding='utf-8') as f:
                    content = f.read()
                    # æœ€åˆã®50è¡Œç¨‹åº¦ã®æ–‡ä½“ã‚µãƒ³ãƒ—ãƒ«ã‚’æŠ½å‡º
                    lines = content.split('\n')
                    sample_lines = []
                    
                    for line in lines:
                        if line.strip() and not line.startswith('(') and not line.startswith('2025/'):
                            sample_lines.append(line)
                            if len(sample_lines) >= 50:
                                break
                    
                    return '\n'.join(sample_lines)
            else:
                # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ–‡ä½“
                return """ãƒãƒŠãƒŸã§ã™ã€‚

ä»Šå›ã¯ã€ŒSNSé‹ç”¨ã§ç–²ã‚ŒãŸæ™‚ã®å¯¾å‡¦æ³•ã€ã«ã¤ã„ã¦è©±ã—ã¾ã™ã€‚

SNSã‚’å§‹ã‚ãŸã°ã‹ã‚Šã®é ƒã¯ã€æ¯æ—¥æŠ•ç¨¿ã™ã‚‹ã“ã¨ã‚„ã€Œã„ã„ã­ã€ã®æ•°ã‚’æ°—ã«ã—ã¦ã—ã¾ã„ãŒã¡ã§ã™ã€‚ã§ã‚‚ã€ãã‚“ãªé¢¨ã«é ‘å¼µã‚Šã™ãã¦ã„ã‚‹ã¨ã€ã ã‚“ã ã‚“ç–²ã‚Œã¦ãã¦ã—ã¾ã†ã‚“ã§ã™ã‚ˆã­ã€‚

ç§ã‚‚æœ€åˆã®é ƒã¯ã€æ¯æ—¥ä½•ã‹ã‚’æŠ•ç¨¿ã—ãªã‘ã‚Œã°ã„ã‘ãªã„ã¨æ€ã£ã¦ã„ã¾ã—ãŸã€‚ã§ã‚‚ã€ãã‚Œã£ã¦ã™ã”ãå¤§å¤‰ãªã“ã¨ãªã‚“ã§ã™ã€‚æ¯æ—¥ãƒã‚¿ã‚’è€ƒãˆã¦ã€å†™çœŸã‚’æ’®ã£ã¦ã€æ–‡ç« ã‚’æ›¸ã„ã¦...ã€‚æ°—ãŒã¤ãã¨ã€SNSã®ã“ã¨ã°ã‹ã‚Šè€ƒãˆã¦ã„ã‚‹è‡ªåˆ†ãŒã„ã¾ã—ãŸã€‚

ãã‚“ãªæ™‚ã«å¤§åˆ‡ãªã®ã¯ã€Œç„¡ç†ã‚’ã—ãªã„ã“ã¨ã€ã§ã™ã€‚æŠ•ç¨¿ã®é »åº¦ã‚’ä¸‹ã’ã¦ã‚‚å¤§ä¸ˆå¤«ã§ã™ã—ã€ãŸã¾ã«ã¯ä¼‘ã‚“ã§ã‚‚æ§‹ã„ã¾ã›ã‚“ã€‚ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ã®æ–¹ã€…ã¯ã€ã‚ãªãŸãŒç„¡ç†ã‚’ã—ã¦ã„ã‚‹ã“ã¨ã‚ˆã‚Šã‚‚ã€è‡ªç„¶ä½“ã§ã„ã‚‹ã“ã¨ã‚’æœ›ã‚“ã§ã„ã‚‹ã¯ãšã§ã™ã€‚"""
        except Exception as e:
            print(f"âŒ æ–‡ä½“ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: {e}")
            return "ãƒãƒŠãƒŸã§ã™ã€‚\n\nä»Šå›ã¯éŸ³å£°é…ä¿¡ã®å†…å®¹ã«ã¤ã„ã¦è©±ã—ã¾ã™ã€‚"

    def init_claude_client(self):
        """Claude APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’åˆæœŸåŒ–"""
        try:
            api_key = os.getenv('ANTHROPIC_API_KEY')
            if not api_key:
                print("âš ï¸ ANTHROPIC_API_KEYãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚.envãƒ•ã‚¡ã‚¤ãƒ«ã«è¨­å®šã—ã¦ãã ã•ã„ã€‚")
                self.claude_client = None
            else:
                self.claude_client = anthropic.Anthropic(api_key=api_key)
                print("âœ… Claude APIæ¥ç¶šæº–å‚™å®Œäº†")
        except Exception as e:
            print(f"âŒ Claude APIåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: {e}")
            self.claude_client = None
    
    def create_article_prompt_template(self) -> str:
        """æ–‡ç« æ•´ç†ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½œæˆ"""
        return f"""# ç›®çš„
ã‚ãªãŸã¯å„ªç§€ãªãƒ©ã‚¤ã‚¿ãƒ¼ã§ã™ã€‚éŸ³å£°é…ä¿¡ã®æ–‡å­—èµ·ã“ã—ãƒ†ã‚­ã‚¹ãƒˆã‚’noteã«æ²è¼‰ã™ã‚‹è¨˜äº‹ã«æ•´ç†ã—ã¾ã™ã€‚

# æœ€é‡è¦
ä»¥ä¸‹ã®æ–‡ä½“ã‚µãƒ³ãƒ—ãƒ«ã‚’å‚è€ƒã«ã€è©±ã—ã¦ã„ã‚‹ã‚ˆã†ãªè‡ªç„¶ãªé›°å›²æ°—ã‚’æ®‹ã—ã¤ã¤ã€èª­ã¿ã‚„ã™ã„æ–‡ç« ã«æ•´ãˆã¦ãã ã•ã„ã€‚

ã€æ–‡ä½“å­¦ç¿’æ¸ˆã¿ã‚µãƒ³ãƒ—ãƒ«ã€‘
{self.style_text[:1000]}...

# è¦æ±‚ä»•æ§˜
å…¨ä½“ã‚’é€šã—ã¦2000æ–‡å­—ç¨‹åº¦ã«åã‚ã‚‹ã‚ˆã†ã«æ§‹æˆã—ã¦ãã ã•ã„ã€‚ä»¥ä¸‹ã®æ§‹æˆã«å¾“ã£ã¦æ•´ç†ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚

1. å°å…¥éƒ¨ï¼ˆç´„150æ–‡å­—ï¼‰:
   - éŸ³å£°é…ä¿¡ã®ä¸»é¡Œã‚’ç°¡æ½”ã«ç´¹ä»‹ã—ã¾ã™ã€‚

2. ä¸»è¦å†…å®¹ï¼ˆç´„1600æ–‡å­—ï¼‰:
   - ä¸»è¦ãªè­°è«–ã‚„ãƒã‚¤ãƒ³ãƒˆã‚’ã€æ˜ç¢ºã‹ã¤ç°¡æ½”ã«æ•´ç†ã—ã¾ã™ã€‚
   - å…ƒã®è©±ã—æ–¹ã®é›°å›²æ°—ã‚’æ®‹ã—ã¤ã¤ã€èª­ã¿ã‚„ã™ãæ§‹æˆã—ã¾ã™ã€‚

3. çµè«–ï¼ˆç´„250æ–‡å­—ï¼‰:
   - ã¾ã¨ã‚ã¨èª­è€…ã¸ã®å‘¼ã³ã‹ã‘ã€‚

# ãã®ä»–ã®åˆ¶ç´„
ãƒ»å†’é ­ã¯ã€ŒãƒãƒŠãƒŸã§ã™ã€‚ã€ã‹ã‚‰å§‹ã‚ã¦ãã ã•ã„
ãƒ»ã€Œã§ã™ã¾ã™èª¿ã€ã§çµ±ä¸€ã—ã¦ãã ã•ã„
ãƒ»å†…å®¹ã‹ã‚‰æ®µè½ã‚ã‘ã€æ”¹è¡Œã‚’é©åˆ‡ã«è¡Œã£ã¦ãã ã•ã„
ãƒ»å¼·èª¿ã™ã‚‹ã¨ã“ã‚ã¯ã€Œã€ã§åŒºåˆ‡ã£ã¦ãã ã•ã„
ãƒ»å­ä¾›ã¯ã€Œå­ã©ã‚‚ã€ã¨è¡¨è¨˜ã—ã¦ãã ã•ã„
ãƒ»è¦‹å‡ºã—ã¯ã¤ã‘ãªã„ã§ãã ã•ã„
ãƒ»ä¸è¦ãªç¹°ã‚Šè¿”ã—ã‚„ã€Œãˆãƒ¼ã€ã€Œã‚ã®ã€ãªã©ã®å£ç™–ã¯å‰Šé™¤ã—ã¦ãã ã•ã„
ãƒ»è‡ªç„¶ãªä¼šè©±èª¿ã‚’æ®‹ã—ã¤ã¤ã€æ–‡ç« ã¨ã—ã¦èª­ã¿ã‚„ã™ãæ•´ãˆã¦ãã ã•ã„

ä»¥ä¸‹ã®æ–‡å­—èµ·ã“ã—ãƒ†ã‚­ã‚¹ãƒˆã‚’æ•´ç†ã—ã¦ãã ã•ã„ï¼š

{{TRANSCRIPT}}"""

    def print_banner(self):
        """ãƒãƒŠãƒ¼è¡¨ç¤º"""
        print("ğŸ™ï¸" + "="*60)
        print("    Whisper + Claude Code éŸ³å£°è¨˜äº‹åŒ–ã‚·ã‚¹ãƒ†ãƒ ")
        print("    ğŸ’° APIã‚³ã‚¹ãƒˆã‚¼ãƒ­ãƒ»ãƒ­ãƒ¼ã‚«ãƒ«å‡¦ç†å¯¾å¿œ")
        print("="*62)
        
        # æ–‡ä½“å­¦ç¿’çŠ¶æ³ã‚’è¡¨ç¤º
        if os.path.exists(self.style_file_path):
            print("âœ… æ–‡ä½“å­¦ç¿’æ¸ˆã¿: noteæœ¬æ–‡.mdã‹ã‚‰æ–‡ä½“ã‚’å­¦ç¿’")
        else:
            print("âš ï¸ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ–‡ä½“ã‚’ä½¿ç”¨")
        print()

    def convert_audio_format(self, input_path: str, output_path: str) -> bool:
        """éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’WAVã«å¤‰æ›"""
        try:
            cmd = [
                'ffmpeg', '-i', input_path, '-acodec', 'pcm_s16le', 
                '-ar', '16000', '-ac', '1', output_path, '-y'
            ]
            result = subprocess.run(cmd, capture_output=True, text=True)
            return result.returncode == 0
        except Exception as e:
            print(f"âŒ éŸ³å£°å¤‰æ›ã‚¨ãƒ©ãƒ¼: {e}")
            return False

    def transcribe_with_whisper(self, audio_path: str) -> str:
        """Whisperã«ã‚ˆã‚‹éŸ³å£°æ–‡å­—èµ·ã“ã—"""
        try:
            self.load_whisper_model()
            print("ğŸ—£ï¸ Whisperã§æ–‡å­—èµ·ã“ã—ä¸­...")
            
            result = self.model.transcribe(audio_path, language="ja")
            transcript = result["text"]
            
            print(f"âœ… æ–‡å­—èµ·ã“ã—å®Œäº† ({len(transcript)}æ–‡å­—)")
            return transcript
            
        except Exception as e:
            print(f"âŒ Whisperæ–‡å­—èµ·ã“ã—ã‚¨ãƒ©ãƒ¼: {e}")
            return None

    def process_with_claude(self, transcript: str) -> str:
        """Claude APIã§æ–‡ç« ã‚’æ•´ç†"""
        if not self.claude_client:
            print("âŒ Claude APIãŒåˆ©ç”¨ã§ãã¾ã›ã‚“")
            return None
        
        try:
            print("ğŸ¤– Claude APIã§æ–‡ç« æ•´ç†ä¸­...")
            
            prompt = self.article_prompt_template.replace("{{TRANSCRIPT}}", transcript)
            
            response = self.claude_client.messages.create(
                model="claude-3-5-sonnet-20241022",
                max_tokens=4000,
                temperature=0.3,
                messages=[
                    {
                        "role": "user",
                        "content": prompt
                    }
                ]
            )
            
            article = response.content[0].text
            print(f"âœ… Claudeæ–‡ç« æ•´ç†å®Œäº† ({len(article)}æ–‡å­—)")
            return article
            
        except Exception as e:
            print(f"âŒ Claude APIå‡¦ç†ã‚¨ãƒ©ãƒ¼: {e}")
            return None

    def save_results(self, transcript: str, article: str, filename: str):
        """çµæœã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜"""
        timestamp = Path(filename).stem
        
        # æ–‡å­—èµ·ã“ã—çµæœã‚’ä¿å­˜
        transcript_file = f"{timestamp}_transcript.txt"
        with open(transcript_file, 'w', encoding='utf-8') as f:
            f.write(transcript)
        
        # æ•´ç†æ¸ˆã¿è¨˜äº‹ã‚’ä¿å­˜
        article_file = f"{timestamp}_article.txt"
        with open(article_file, 'w', encoding='utf-8') as f:
            f.write(article)
        
        return transcript_file, article_file

    def display_results(self, transcript: str, article: str, filename: str):
        """çµæœã‚’è¡¨ç¤º"""
        print("\n" + "="*80)
        print("âœ¨ è¨˜äº‹ä½œæˆå®Œäº†ï¼")
        print("="*80)
        print(f"ğŸ“ å…ƒãƒ•ã‚¡ã‚¤ãƒ«: {filename}")
        print(f"ğŸ“ æ–‡å­—èµ·ã“ã—æ–‡å­—æ•°: {len(transcript)}æ–‡å­—")
        if article:
            print(f"ğŸ“° å®Œæˆè¨˜äº‹æ–‡å­—æ•°: {len(article)}æ–‡å­—")
        print("="*80)
        
        if article:
            print("\nğŸ“° å®Œæˆè¨˜äº‹:")
            print("-" * 80)
            print(article)
            print("-" * 80)
            
            # ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
            try:
                pyperclip.copy(article)
                print("\nğŸ“‹ è¨˜äº‹ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼")
            except Exception as e:
                print(f"âš ï¸ ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‚³ãƒ”ãƒ¼ã«å¤±æ•—: {e}")
        else:
            print("\nğŸ“„ æ–‡å­—èµ·ã“ã—çµæœ:")
            print("-" * 40)
            print(transcript)
        
        # ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³
        save_option = input("\nğŸ’¾ çµæœã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ (y/N): ").lower().strip()
        if save_option in ['y', 'yes']:
            try:
                if article:
                    transcript_file, article_file = self.save_results(transcript, article, filename)
                    print(f"âœ… æ–‡å­—èµ·ã“ã—: {transcript_file}")
                    print(f"âœ… å®Œæˆè¨˜äº‹: {article_file}")
                else:
                    timestamp = Path(filename).stem
                    transcript_file = f"{timestamp}_transcript.txt"
                    with open(transcript_file, 'w', encoding='utf-8') as f:
                        f.write(transcript)
                    print(f"âœ… æ–‡å­—èµ·ã“ã—: {transcript_file}")
            except Exception as e:
                print(f"âŒ ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: {e}")

    def process_audio_file(self, audio_path: str):
        """éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®å‡¦ç†ãƒ¡ã‚¤ãƒ³"""
        try:
            filename = Path(audio_path).name
            print(f"ğŸµ å‡¦ç†é–‹å§‹: {filename}")
            
            # éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›
            wav_path = None
            file_ext = Path(audio_path).suffix.lower()
            
            if file_ext != '.wav':
                print("ğŸ”„ éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¤‰æ›ä¸­...")
                with tempfile.NamedTemporaryFile(suffix='.wav', delete=False) as temp_wav:
                    wav_path = temp_wav.name
                
                if not self.convert_audio_format(audio_path, wav_path):
                    print("âš ï¸ éŸ³å£°å¤‰æ›ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å…ƒãƒ•ã‚¡ã‚¤ãƒ«ã§è©¦è¡Œã—ã¾ã™ã€‚")
                    wav_path = audio_path
            else:
                wav_path = audio_path
            
            # Whisperã§æ–‡å­—èµ·ã“ã—
            transcript = self.transcribe_with_whisper(wav_path)
            
            if not transcript:
                print("âŒ æ–‡å­—èµ·ã“ã—ã«å¤±æ•—ã—ã¾ã—ãŸ")
                return
            
            # Claudeã§æ–‡ç« æ•´ç†
            article = None
            if self.claude_client:
                article = self.process_with_claude(transcript)
            
            # çµæœè¡¨ç¤º
            self.display_results(transcript, article, filename)
            
        except Exception as e:
            print(f"âŒ å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
        finally:
            # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
            if wav_path and wav_path != audio_path and os.path.exists(wav_path):
                os.remove(wav_path)

def main():
    transcriber = WhisperTranscriber()
    transcriber.print_banner()
    
    parser = argparse.ArgumentParser(description="WhisperéŸ³å£°æ–‡å­—èµ·ã“ã— + Claude Codeè¨˜äº‹ç”Ÿæˆ")
    parser.add_argument("audio_file", nargs="?", help="éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹")
    parser.add_argument("--model", default="base", choices=["tiny", "base", "small", "medium", "large"],
                       help="ä½¿ç”¨ã™ã‚‹Whisperãƒ¢ãƒ‡ãƒ« (default: base)")
    
    args = parser.parse_args()
    
    if args.model:
        transcriber.model_name = args.model
    
    if args.audio_file:
        # ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ã‹ã‚‰
        if not os.path.exists(args.audio_file):
            print("âŒ ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:", args.audio_file)
            return
        
        transcriber.process_audio_file(args.audio_file)
    else:
        # ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãƒ¢ãƒ¼ãƒ‰
        print("ğŸ’¡ ä½¿ç”¨æ–¹æ³•:")
        print("   1. ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—")
        print("   2. ã¾ãŸã¯ã‚³ãƒãƒ³ãƒ‰: python whisper_transcriber.py [éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹]")
        print("   3. ã‚ªãƒ—ã‚·ãƒ§ãƒ³: --model [tiny/base/small/medium/large]")
        print()
        
        while True:
            try:
                file_path = input("ğŸ™ï¸ éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã‚’å…¥åŠ› (ã¾ãŸã¯ 'q' ã§çµ‚äº†): ").strip()
                
                if file_path.lower() == 'q':
                    break
                
                # ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—æ™‚ã®å¼•ç”¨ç¬¦ã‚’å‰Šé™¤
                file_path = file_path.strip('"').strip("'")
                
                if not os.path.exists(file_path):
                    print("âŒ ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
                    continue
                
                transcriber.process_audio_file(file_path)
                
                # ç¶šè¡Œç¢ºèª
                continue_option = input("\nğŸ”„ åˆ¥ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†ã—ã¾ã™ã‹ï¼Ÿ (y/N): ").lower().strip()
                if continue_option not in ['y', 'yes']:
                    break
                
            except KeyboardInterrupt:
                print("\nğŸ‘‹ çµ‚äº†ã—ã¾ã™")
                break
            except Exception as e:
                print(f"âŒ ã‚¨ãƒ©ãƒ¼: {e}")

if __name__ == "__main__":
    main()