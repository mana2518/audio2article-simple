#!/usr/bin/env python3
"""
ã‚·ãƒ³ãƒ—ãƒ«Noteè¨˜äº‹ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ 
éŸ³å£° â†’ Whisperæ–‡å­—èµ·ã“ã— â†’ Claude APIè¨˜äº‹ç”Ÿæˆ â†’ ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‚³ãƒ”ãƒ¼
"""

import os
import sys
from pathlib import Path

def main():
    print("ğŸ™ï¸ ã‚·ãƒ³ãƒ—ãƒ«Noteè¨˜äº‹ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ ")
    print("="*50)
    
    # 1. å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ãƒã‚§ãƒƒã‚¯
    try:
        import whisper
        import anthropic
        import pyperclip
    except ImportError as e:
        print(f"âŒ å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒã‚ã‚Šã¾ã›ã‚“: {e}")
        print("ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«: pip3 install --user --break-system-packages openai-whisper anthropic pyperclip")
        return
    
    # 2. APIã‚­ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯
    api_key = os.getenv('ANTHROPIC_API_KEY')
    if not api_key:
        print("âŒ ANTHROPIC_API_KEYãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")
        print("è¨­å®š: export ANTHROPIC_API_KEY='your-api-key'")
        return
    
    # 3. å‚è€ƒæ–‡ä½“ã‚’èª­ã¿è¾¼ã¿
    reference_text = """ãƒãƒŠãƒŸã§ã™ã€‚

ä»Šæ—¥ã¯ã€ç§ãŒæœ€è¿‘æ„Ÿã˜ã¦ã„ã‚‹ã“ã¨ã«ã¤ã„ã¦ãŠè©±ã—ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

ãƒ•ãƒªãƒ¼ãƒ©ãƒ³ã‚¹ã¨ã—ã¦åƒã„ã¦ã„ã‚‹ã¨ã€æ—¥ã€…è‰²ã€…ãªç™ºè¦‹ãŒã‚ã‚Šã¾ã™ã€‚ç‰¹ã«æœ€è¿‘ã¯ã€åŠ¹ç‡çš„ãªåƒãæ–¹ã«ã¤ã„ã¦è€ƒãˆã‚‹ã“ã¨ãŒå¤šããªã‚Šã¾ã—ãŸã€‚

å­ã©ã‚‚ãŸã¡ã¨ã®æ™‚é–“ã‚‚å¤§åˆ‡ã«ã—ãŸã„ã§ã™ã—ã€ä»•äº‹ã‚‚å……å®Ÿã•ã›ãŸã„ã€‚ãã®ãƒãƒ©ãƒ³ã‚¹ã‚’å–ã‚‹ã®ã¯ç°¡å˜ã§ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€å°‘ã—ãšã¤è‡ªåˆ†ãªã‚Šã®æ–¹æ³•ã‚’è¦‹ã¤ã‘ã¦ã„ã¾ã™ã€‚

çš†ã•ã‚“ã‚‚ã€ãã£ã¨åŒã˜ã‚ˆã†ãªæ‚©ã¿ã‚’æŠ±ãˆã¦ã„ã‚‹ã®ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ã€‚

ä»Šå¾Œã‚‚ã€ã“ã†ã—ãŸæ—¥å¸¸ã®æ°—ã¥ãã‚„å­¦ã³ã‚’ã€çš†ã•ã‚“ã¨å…±æœ‰ã—ã¦ã„ããŸã„ã¨æ€ã£ã¦ã„ã¾ã™ã€‚"""
    
    reference_file = Path("/Users/manami/(N)noteæœ¬æ–‡.md")
    if reference_file.exists():
        try:
            with open(reference_file, 'r', encoding='utf-8') as f:
                reference_text = f.read()[:3000]
            print("âœ… å‚è€ƒæ–‡ä½“ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ")
        except:
            print("âš ï¸ å‚è€ƒæ–‡ä½“ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’ä½¿ç”¨ã—ã¾ã™")
    
    # 4. éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã‚’å–å¾—
    while True:
        audio_input = input("\nğŸ“ éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (qã§çµ‚äº†): ").strip()
        if audio_input.lower() == 'q':
            print("ğŸ‘‹ çµ‚äº†ã—ã¾ã™")
            return
        
        # ãƒ‘ã‚¹ã‚’æ•´ç†
        audio_input = audio_input.strip('"').strip("'")
        audio_input = audio_input.replace('\\ ', ' ')
        audio_input = os.path.expanduser(audio_input)
        audio_path = Path(audio_input)
        
        if not audio_path.exists():
            print(f"âŒ ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: {audio_path}")
            continue
        
        print(f"ğŸµ å‡¦ç†é–‹å§‹: {audio_path.name}")
        
        # 5. éŸ³å£°ã‚’æ–‡å­—èµ·ã“ã—
        try:
            print("ğŸ“¥ Whisperã§æ–‡å­—èµ·ã“ã—ã—ã¦ã„ã¾ã™...")
            model = whisper.load_model("base")
            
            # å‡ºåŠ›ã‚’æŠ‘åˆ¶ã—ã¦æ–‡å­—èµ·ã“ã—
            import io
            import contextlib
            with contextlib.redirect_stdout(io.StringIO()):
                result = model.transcribe(str(audio_path), language="ja", verbose=False)
            
            transcript = result["text"].strip()
            if len(transcript) < 50:
                print("âŒ æ–‡å­—èµ·ã“ã—çµæœãŒçŸ­ã™ãã¾ã™")
                continue
            
            print(f"âœ… æ–‡å­—èµ·ã“ã—å®Œäº†: {len(transcript)}æ–‡å­—")
            
        except Exception as e:
            print(f"âŒ æ–‡å­—èµ·ã“ã—ã‚¨ãƒ©ãƒ¼: {e}")
            continue
        
        # 6. Claude APIã§è¨˜äº‹ç”Ÿæˆ
        try:
            print("ğŸ¤– Claude APIã§è¨˜äº‹ç”Ÿæˆä¸­...")
            
            prompt = f"""#ç›®çš„
ã‚ãªãŸã¯å„ªç§€ãªãƒ©ã‚¤ã‚¿ãƒ¼ã§ã™ã€‚noteã«æ²è¼‰ã™ã‚‹è¨˜äº‹ã‚’ä½œæˆã—ã¾ã™ã€‚

#æœ€é‡è¦
æ–‡ä½“ã‚„å£èª¿ã¯ä¸»ã«ã€ŒçŸ¥è­˜ã€ã®ä¸­ã«ã‚ã‚‹ã€Œç·¨é›†æ¸ˆã¿ã€€noteæœ¬æ–‡ã€ã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚ãªã‚‹ã¹ãè©±ã—ã¦ã„ã‚‹ã‚ˆã†ãªé›°å›²æ°—ã‚’æ®‹ã—ã¦ã»ã—ã„ã§ã™ã€‚

## çŸ¥è­˜ï¼ˆç·¨é›†æ¸ˆã¿ã€€noteæœ¬æ–‡ï¼‰
```
{reference_text}
```

è¦æ±‚: æ·»ä»˜ã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆã¯ã€éŸ³å£°é…ä¿¡ã®å†…å®¹ã®æ–‡å­—èµ·ã“ã—ãƒ‡ãƒ¼ã‚¿ï¼ˆæ—¥æœ¬èªï¼‰ã§ã™ã€‚å…¨ä½“ã‚’é€šã—ã¦2500æ–‡å­—ç¨‹åº¦ã«åã‚ã‚‹ã‚ˆã†ã«æ§‹æˆã—ã¦ãã ã•ã„ã€‚ä»¥ä¸‹ã®æ§‹æˆã«å¾“ã£ã¦è¦ç´„ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚

## å…¥åŠ›ãƒ‡ãƒ¼ã‚¿
ä»¥ä¸‹ã¯éŸ³å£°é…ä¿¡ã®æ–‡å­—èµ·ã“ã—ãƒ‡ãƒ¼ã‚¿ã§ã™ï¼š
```
{transcript}
```

1. å°å…¥éƒ¨ï¼ˆç´„200æ–‡å­—ï¼‰:
   - éŸ³å£°é…ä¿¡ã®ä¸»é¡Œã‚’çµè«–ã€ãã®é‡è¦æ€§ã‚’ç°¡æ½”ã«ç´¹ä»‹ã—ã¾ã™ã€‚

2. ä¸»è¦å†…å®¹ã®è¦ç´„ï¼ˆç´„2000æ–‡å­—ï¼‰:
   - ä¸»è¦ãªè­°è«–ã‚„ãƒã‚¤ãƒ³ãƒˆã‚’ã€æ˜ç¢ºã‹ã¤ç°¡æ½”ã«è¦ç´„ã—ã¾ã™ã€‚

3. çµè«–ï¼ˆç´„300æ–‡å­—ï¼‰:

ã“ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’é€šã˜ã¦ã€ãƒªã‚¹ãƒŠãƒ¼ãŒå…ƒã®éŸ³å£°é…ä¿¡ã‹ã‚‰å¾—ã‚‹ã“ã¨ãŒã§ãã‚‹ä¸»è¦ãªçŸ¥è¦‹ã¨æƒ…å ±ã‚’åŠ¹æœçš„ã«ä¼ãˆã‚‹ã“ã¨ãŒç›®çš„ã§ã™ã€‚å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯æƒ…å ±ã‚’é©åˆ‡ã«è¦ç´„ã—ã€èª­è€…ã«ã¨ã£ã¦ç†è§£ã—ã‚„ã™ãã€ã‹ã¤æƒ…å ±é‡ãŒè±Šå¯Œã§ã‚ã‚‹ã“ã¨ã‚’å¿ƒæ›ã‘ã¦ãã ã•ã„ã€‚

ãã®ä»–ã®åˆ¶ç´„ï¼š
ãƒ»æœ€åˆã®è‡ªå·±ç´¹ä»‹æ–‡ã€Œ3äººã®å­ä¾›é”ã‚’è‚²ã¦ãªãŒã‚‰SNSç™ºä¿¡ã‚’ã—ã¦ã„ã‚‹ãƒãƒãƒ•ãƒªãƒ¼ãƒ©ãƒ³ã‚¹ã§ã™ã€ã¯å‰Šé™¤ã—ã€ã€ŒãƒãƒŠãƒŸã§ã™ã€‚ã€â†’ã™ãæœ¬æ–‡ã¸ç¶šã‘ã¦ãã ã•ã„ã€‚
ãƒ»ã€Œã§ã™ã¾ã™èª¿ã€ã«ã—ã¦ãã ã•ã„ã€‚
ãƒ»å†…å®¹ã‹ã‚‰æ®µè½ã‚ã‘ã€æ”¹è¡Œã‚’é©åˆ‡ã«è¡Œã£ã¦ãã ã•ã„
ãƒ»å¼·èª¿ã™ã‚‹ã¨ã“ã‚ã¯ã€Œã€ã§åŒºåˆ‡ã£ã¦ãã ã•ã„
ãƒ»å­ä¾›ã¯ã€Œå­ã©ã‚‚ã€ã¨è¡¨è¨˜ã—ã¦ãã ã•ã„
ãƒ»è¦‹å‡ºã—ã‚’ã¤ã‘ãªã„ã§ãã ã•ã„

ãã‚Œã§ã¯è¨˜äº‹ã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š"""
            
            client = anthropic.Anthropic(api_key=api_key)
            response = client.messages.create(
                model="claude-3-haiku-20240307",
                max_tokens=3000,
                messages=[{"role": "user", "content": prompt}]
            )
            
            article = response.content[0].text.strip()
            print("âœ… è¨˜äº‹ç”Ÿæˆå®Œäº†")
            
        except Exception as e:
            print(f"âŒ è¨˜äº‹ç”Ÿæˆã‚¨ãƒ©ãƒ¼: {e}")
            continue
        
        # 7. çµæœã‚’è¡¨ç¤ºãƒ»ä¿å­˜ãƒ»ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
        try:
            # è¨˜äº‹ã‚’ä¿å­˜
            os.makedirs("output", exist_ok=True)
            output_file = Path("output") / f"{audio_path.stem}_article.txt"
            with open(output_file, 'w', encoding='utf-8') as f:
                f.write(article)
            
            # ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
            pyperclip.copy(article)
            
            print("\n" + "="*60)
            print("ğŸ“– ç”Ÿæˆã•ã‚ŒãŸè¨˜äº‹:")
            print("="*60)
            print(article)
            print("="*60)
            
            print(f"\nâœ… å®Œäº†!")
            print(f"ğŸ“‹ è¨˜äº‹ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ")
            print(f"ğŸ“ è¨˜äº‹ã‚’ä¿å­˜: {output_file}")
            
        except Exception as e:
            print(f"âŒ ä¿å­˜ãƒ»ã‚³ãƒ”ãƒ¼ã‚¨ãƒ©ãƒ¼: {e}")
            print("è¨˜äº‹å†…å®¹:")
            print(article)
        
        # 8. ç¶™ç¶šç¢ºèª
        while True:
            continue_input = input("\nğŸ”„ åˆ¥ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†ã—ã¾ã™ã‹ï¼Ÿ (y/N): ").strip().lower()
            if continue_input in ['', 'n', 'no']:
                print("ğŸ‘‹ ãŠç–²ã‚Œã•ã¾ã§ã—ãŸï¼")
                return
            elif continue_input in ['y', 'yes']:
                break
            else:
                print("âŒ 'y' ã¾ãŸã¯ 'n' ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„")

if __name__ == "__main__":
    main()