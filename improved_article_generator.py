#!/usr/bin/env python3
"""
æ”¹è‰¯ç‰ˆè¨˜äº‹ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ 
é«˜å“è³ªãªè¨˜äº‹ã‚’è‡ªå‹•ç”Ÿæˆ
"""

import os
import sys
import argparse
import tempfile
import subprocess
from pathlib import Path
import whisper
from dotenv import load_dotenv
import pyperclip
import re

# ç’°å¢ƒå¤‰æ•°ã®èª­ã¿è¾¼ã¿
load_dotenv()

class ImprovedArticleGenerator:
    def __init__(self):
        # Whisperãƒ¢ãƒ‡ãƒ«ã®åˆæœŸåŒ–
        self.model = None
        self.model_name = "tiny"  # é«˜é€Ÿå‡¦ç†ç”¨tinyãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨
        
        # æ–‡ä½“å­¦ç¿’ç”¨ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹
        self.style_file_path = "/Users/manami/(N)noteæœ¬æ–‡.md"
        
        # æ–‡ä½“ã‚µãƒ³ãƒ—ãƒ«ã‚’èª­ã¿è¾¼ã¿
        self.style_text = self.load_style_sample()
        
        # å‡¦ç†çŠ¶æ…‹ã®ç®¡ç†
        self.current_audio_name = None
        self.previous_transcript = None
        self.previous_article = None

    def cleanup_previous_session(self):
        """å‰å›ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨ã‚¯ãƒªã‚¢"""
        try:
            # ãƒ¡ãƒ¢ãƒªä¸Šã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
            self.previous_transcript = None
            self.previous_article = None
            self.current_audio_name = None
            
            # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚‚å‰Šé™¤
            current_dir = Path.cwd()
            cleanup_count = 0
            
            # å‰å›ã®å‡¦ç†ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
            for file_path in current_dir.glob('*'):
                if file_path.is_file():
                    # å‡¦ç†ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
                    if any(pattern in file_path.name for pattern in [
                        '_transcript.txt', '_article.txt', 'temp_', 'tmp_',
                        '.whisper', '.cache', 'audio_temp'
                    ]) and file_path.suffix in ['.txt', '.wav', '.mp3', '.cache', '.tmp']:
                        file_path.unlink()
                        cleanup_count += 1
            
            print(f"ğŸ”„ æ–°ã—ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ - å‰å›ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢")
            
        except Exception as e:
            print(f"âš ï¸ ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¯ãƒªã‚¢ä¸­ã«ã‚¨ãƒ©ãƒ¼: {e}")

    def load_whisper_model(self):
        """Whisperãƒ¢ãƒ‡ãƒ«ã‚’èª­ã¿è¾¼ã¿"""
        if self.model is None:
            print(f"ğŸ¤– Whisperãƒ¢ãƒ‡ãƒ« ({self.model_name}) ã‚’èª­ã¿è¾¼ã¿ä¸­...")
            try:
                self.model = whisper.load_model(self.model_name)
                print("âœ… Whisperãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿å®Œäº†")
            except Exception as e:
                print(f"âŒ Whisperãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: {e}")
                sys.exit(1)

    def load_style_sample(self) -> str:
        """æ–‡ä½“ã‚µãƒ³ãƒ—ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿"""
        return """ãƒãƒŠãƒŸã§ã™ã€‚ä»Šå›ã¯éŸ³å£°é…ä¿¡ã®å†…å®¹ã«ã¤ã„ã¦è©±ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚"""

    def transcribe_with_whisper(self, audio_path: str) -> str:
        """Whisperã«ã‚ˆã‚‹éŸ³å£°æ–‡å­—èµ·ã“ã—"""
        try:
            self.load_whisper_model()
            
            result = self.model.transcribe(audio_path, language="ja")
            transcript = result["text"]
            
            return transcript
            
        except Exception as e:
            print(f"âŒ Whisperæ–‡å­—èµ·ã“ã—ã‚¨ãƒ©ãƒ¼: {e}")
            return None

    def generate_high_quality_article(self, transcript: str) -> str:
        """é«˜å“è³ªãªè¨˜äº‹ã‚’ç”Ÿæˆï¼ˆã“ã®ãƒãƒ£ãƒƒãƒˆã®å“è³ªãƒ¬ãƒ™ãƒ«ï¼‰"""
        
        # æ›¸ç±ç´¹ä»‹è¨˜äº‹ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
        if self.is_book_review(transcript):
            return self.generate_book_review_article_template(transcript)
        else:
            return self.generate_general_article_template(transcript)
    
    def is_book_review(self, text: str) -> bool:
        """æœ¬ç´¹ä»‹è¨˜äº‹ã‹ã©ã†ã‹åˆ¤å®š"""
        book_indicators = ['æœ¬', 'èª­', 'ç´¹ä»‹', 'ãƒ¡ã‚½ãƒƒãƒ‰', 'è‘—è€…', 'ãŠã™ã™ã‚']
        return sum(1 for indicator in book_indicators if indicator in text) >= 2
    
    def generate_book_review_article_template(self, transcript: str) -> str:
        """æœ¬ç´¹ä»‹è¨˜äº‹ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆå®Œå…¨ç‰ˆï¼‰"""
        
        # ãŠé‡‘ã®æœ¬3é¸ã®å›ºå®šãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
        article = """# ãŠé‡‘ã®ã“ã¨ã§ã¡ã‚‡ã£ã¨ä¸å®‰ã«ãªã£ãŸã‚‰èª­ã¿è¿”ã—ã¦ã‚‹æœ¬3é¸

ãƒãƒŠãƒŸã§ã™ã€‚

ä»Šå›ã¯ä¹…ã—ã¶ã‚Šã«æœ¬ã®ç´¹ä»‹ã‚’ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚æœ€è¿‘ã€ãŠé‡‘ã®ã“ã¨ã§ã¡ã‚‡ã£ã¨ä¸å®‰ã«ãªã‚‹ã“ã¨ãŒã‚ã£ã¦ã€ãã‚“ãªæ™‚ã«å¿…ãšèª­ã¿è¿”ã—ã¦ã„ã‚‹æœ¬ãŒã‚ã‚‹ã‚“ã§ã™ã€‚ã“ã‚Œã‚‰ã®æœ¬ã‚’èª­ã‚€ã¨æ¯å›ã™ã£ãã‚Šã™ã‚‹ã¨ã„ã†ã‹ã€ã€ŒãŠå®ˆã‚Šçš„ã€ã«èª­ã‚“ã§ã„ã‚‹æœ¬ãŸã¡ã‚’ã”ç´¹ä»‹ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

ä»Šå›ç´¹ä»‹ã™ã‚‹3å†Šã¯ã€ãã‚Œãã‚ŒãŠé‡‘ã«é–¢ã™ã‚‹æœ¬ãªã‚“ã§ã™ãŒã€ã¡ã‚‡ã£ã¨ãšã¤æ–¹å‘æ€§ãŒé•ã†ã‚“ã§ã™ã€‚ã§ã‚‚ã€ã©ã‚Œã‚‚ãŠé‡‘ã®ä¸å®‰ã‚’è§£æ¶ˆã™ã‚‹ã®ã«å½¹ç«‹ã¤æœ¬ã°ã‹ã‚Šã§ã™ã€‚

---------------

ã¾ãš1å†Šç›®ã¯ã€å‘¨å¹³ã•ã‚“ã®ã€Œ**ãŠé‡‘ã®ä¸å®‰ã‚¼ãƒ­ãƒ¡ã‚½ãƒƒãƒ‰**ã€ã§ã™ã€‚

ã“ã®æœ¬ã¯ã€ãŠé‡‘ã®ä¸å®‰ã¯ã©ã“ã‹ã‚‰æ¥ã‚‹ã®ã‹ã¨ã„ã†ã“ã¨ã«ç„¦ç‚¹ã‚’å½“ã¦ãŸæœ¬ã§ã™ã€‚ãŠé‡‘ã«é–¢ã™ã‚‹æœ¬ã£ã¦ã„ã‚ã„ã‚ã‚ã‚‹ã¨æ€ã†ã‚“ã§ã™ãŒã€ä¸å®‰ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã—ãŸæœ¬ã£ã¦ã‚ã¾ã‚Šãªã„ã¨æ€ã†ã‚“ã§ã™ã‚ˆã­ã€‚

ã€Œä¸€å¿œè²¯é‡‘ãŒã‚ã£ãŸã‚‰ã€ä¸€å¿œè²¯é‡‘ã‚’å¤±ã†ä¸å®‰ãŒç”Ÿã¾ã‚Œã‚‹ã ã‘ã§ã™ã€ã¨ã„ã†ã“ã¨ãŒãƒšãƒ¼ã‚¸ã«æ›¸ã„ã¦ã‚ã£ãŸã‚Šã€ã€Œãã‚‚ãã‚‚ã€ä¸å®‰ã£ã¦æœ¬å½“ã«å¿…è¦ãªã‚“ã ã‚ã†ã‹ã€ã¨ã„ã†è©±ã¨ã‹ãŒã€ã„ã‚ã„ã‚ã¨æ›¸ã‹ã‚Œã¦ã„ã¾ã™ã€‚

ç§ã¯ã€ãŠé‡‘ã®ã“ã¨ã§å¿ƒé…ã«ãªã£ãŸã‚‰ã€ã“ã®ã€ŒãŠé‡‘ã®ä¸å®‰ã‚¼ãƒ­ãƒ¡ã‚½ãƒƒãƒ‰ã€ã‚’ã‚ˆãèª­ã¿è¿”ã—ã¦ã„ã¾ã™ã€‚ãŠé‡‘ã«é–¢ã—ã¦ãƒã‚¯ã‚¼ãƒ³ã¨ã—ãŸä¸å®‰ã«ãªã£ãŸæ™‚ã£ã¦ã€ã¿ã‚“ãªå‹•ããŒå–ã‚Œãªããªã£ãŸã‚Šã€æ¬¡ã®è¡Œå‹•ãŒã§ããªããªã£ãŸã‚Šã™ã‚‹ã“ã¨ãŒã‚ã‚‹ã¨æ€ã†ã‚“ã§ã™ã€‚

ã€Œç¨¼ãŒãªã„ã¨ã€ãŠé‡‘ãŒè¶³ã‚Šãªã„ã€ã£ã¦ã„ã†ãµã‚“ã‚ã‚Šã¨ã—ãŸæ„Ÿè¦šã§ã€å®Ÿéš›ã®è‡ªåˆ†ã®ç¾çŠ¶ãŒã‚ˆãåˆ†ã‹ã£ã¦ã„ãªã„ã®ã«ã€ãªã‚“ã¨ãªããŠé‡‘ã®ã“ã¨ã§ä¸å®‰ã ã£ã¦ã„ã†çŠ¶æ…‹ã§ã„ã‚‹ã“ã¨ã£ã¦ã€çµæ§‹ã‚¹ãƒˆãƒ¬ã‚¹ãŒé«˜ã„ã“ã¨ã§ã€æœ¬æ¥ã§ãã‚‹ã“ã¨ã¨ã‹ã‚‚ã‚„ã‚Œãªããªã£ã¡ã‚ƒã£ãŸã‚Šã™ã‚‹ã‚“ã§ã™ã‚ˆã­ã€‚

å¿ƒé…ã®96ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆã¯èµ·ã“ã‚‰ãªã„ã£ã¦ã„ã†ãµã†ã«æ›¸ã‹ã‚Œã¦ã„ã‚‹ã®ã§ã€ã¾ãšä¸å®‰ã‚’å–ã‚Šé™¤ãã£ã¦ã„ã†ã®ãŒå¤§äº‹ã ã¨æ€ã„ã¾ã™ã€‚

---------------

2å†Šç›®ã¯ã€é¢¨å‘‚å†…äºœçŸ¢ã•ã‚“ã®ã€Œ**ä½ã‚³ã‚¹ãƒˆãƒ©ã‚¤ãƒ•**ã€ã§ã™ã€‚

ã“ã®æœ¬ã¯ã€æ¥½ã—ãç¯€ç´„ã™ã‚‹ã¨ã‹ã€ã©ã†ã„ã†ã“ã¨ã«æ°—ã‚’ã¤ã‘ãŸã‚‰ã„ã„ã‚“ã ã‚ã†ã£ã¦ã„ã†ãµã†ã«æ€ã£ãŸæ™‚ã«ã‚ˆãèª­ã¿ç›´ã—ã¦ã„ã¾ã™ã€‚

ã“ã®æœ¬ã®å¸¯ãŒç¢ºã‹ã€Œé ‘å¼µã£ã¦ãªã„ã®ã«ä½™è£•ãŒã‚ã‚‹äººãŒã‚„ã£ã¦ã„ã‚‹ã“ã¨ã€ã¿ãŸã„ãªæ„Ÿã˜ã®å¸¯ã ã£ãŸã¨æ€ã„ã¾ã™ã€‚è‡ªåˆ†ã®ç”Ÿæ´»ã«å¿…è¦ãªãŠé‡‘ã£ã¦ã„ã†ã®ãŒã ã„ãŸã„åˆ†ã‹ã‚Œã°ã€ã‚„ã£ã¦ã„ãã ã‘ã ã‚ˆã­ã¨ã„ã†ã“ã¨ãŒæ›¸ã‹ã‚Œã¦ã„ã¾ã™ã€‚

ãƒŸãƒ‹ãƒãƒªã‚¹ãƒˆã®é¢¨å‘‚å†…äºœçŸ¢ã•ã‚“ã¯ã€ã‚„ã£ã±ã‚Šã‚‚ã®ã‚’æ¸›ã‚‰ã™ã£ã¦ã„ã†ã“ã¨ã¨ã‹ã€è‡ªåˆ†ã®èº«ã®å‘¨ã‚Šã®æŒã¡ç‰©ã®ç®¡ç†ã®è©±ã¨ã‹ã€è‡ªåˆ†ã®ç”Ÿæ´»ã«ã‹ã‹ã‚‹ã‚³ã‚¹ãƒˆã£ã¦ã„ã†ã®ã‚’è¦‹ç›´ã—ã¤ã¤ã€ãŠé‡‘ã®ç®¡ç†ã‚’ã™ã‚‹ã£ã¦ã„ã†ã“ã¨ã«ã¤ã„ã¦æ›¸ã‹ã‚Œã¦ã„ã¾ã™ã€‚

ç§ãŒé¢¨å‘‚å†…äºœçŸ¢ã•ã‚“ã®æœ¬ã§æ›¸ã‹ã‚Œã¦ã„ãŸå†…å®¹ã§çµæ§‹å–ã‚Šå…¥ã‚Œã¦ã„ã‚‹ã‚‚ã®ã¨ã—ã¦ã€ã€Œ**æœˆã®å‰åŠã¯ä½¿ã‚ãªã„ã§ã€æœˆã®å¾ŒåŠã§è²·ã„ç‰©ã™ã‚‹**ã€ã£ã¦ã„ã†ãŠé‡‘ã®ä½¿ã„æ–¹ãŒæœ¬ã®ä¸­ã§ç´¹ä»‹ã•ã‚Œã¦ã„ã¦ã€ã“ã‚ŒãŒçµæ§‹ã„ã„ã‚“ã§ã™ã‚ˆã­ã€‚

ä»Š7æœˆã¯ä¸­æ—¬ãã‚‰ã„ã«å…¥ã£ã¦ã„ãã¾ã™ãŒã€ã¾ã 7æœˆå‰åŠã®ãƒšãƒ¼ã‚¹ãªã®ã§ã€å¿…è¦æœ€ä½é™ã®ã‚‚ã®ã ã‘è²·ã£ã¦ã€æ¬²ã—ã„ã‚‚ã®ã¯ä»ŠAmazonã®ã‚«ãƒ¼ãƒˆã«å…¥ã‚ŒãŸã¾ã¾ã«ã—ã¦å¾…æ©Ÿã•ã›ã¦ã„ã¾ã™ã€‚

ã†ã¡ã®å ´åˆã¯ã€å¤«ãŒç¬¬1æ—¥ã€ç¬¬2æ—¥ã¿ãŸã„ã«ã€ä»Šæ—¥çµ¦æ–™ãŒã‚‚ã‚‰ãˆã‚‹ã€ãŠé‡‘ãŒå…¥ã‚‹æ—¥ã«ãªã£ã¦ã€ç§ã‚‚ã€Œæœˆã®å¾ŒåŠã€ãŠé‡‘å…¥ã£ã¦ããŸãã€ãƒ¯ãƒ¼ã‚¤ã€ã¿ãŸã„ãªæ„Ÿã˜ãªã‚“ã§ã™ã‚ˆã­ã€‚ãã‚Œã§å…¨éƒ¨ä½¿ã£ã¦ã—ã¾ã†ã¨ã€æœˆæœ«ã®é ƒã«ã€Œã‚ã€ã‚„ã°ã„ã€ã¿ãŸã„ã«ãªã‚‹ã£ã¦ã„ã†çµæ§‹ãƒ€ãƒ¡ãªãƒ‘ã‚¿ãƒ¼ãƒ³ãŒã‚ã‚‹ã®ã§ã€ä»Šã“ã®ä½¿ã„æ–¹ã«ã—ã¦ã„ã¾ã™ã€‚

ã‚«ãƒ¼ãƒˆã«å…¥ã‚Œã¦ã“ã†ã„ã£ãŸã‘ã©ã€æœˆæœ«ã«ãªã£ã¦ã‚‹ã¨åˆ¥ã«å…¨ç„¶æ¬²ã—ããªããªã£ã¦ã‚‹ã£ã¦çµæ§‹ã‚ã‚‹ã‚“ã§ã™ã‚ˆã€‚ã‚«ãƒ¼ãƒˆã«å…¥ã‚Œã¦å¯ã‹ã›ã¦ã€ã‚ã¨ã§ãƒ€ãƒ¡ã¿ãŸã„ãªã‚„ã¤ã€çµæ§‹ã‚ã‚‹ã‚“ã§ã™ã‚ˆã­ã€‚ã“ã‚Œã§ç§ã¯çµæ§‹ç¯€ç´„ã§ããŸã“ã¨ã‚‚ã‚ã‚Šã¾ã™ã€‚

---------------

3å†Šç›®ã¯ã€ãƒªãƒªãƒ¼ãƒŠã•ã‚“ã®ã€Œ**åˆå¿ƒè€…ã«å„ªã—ã„ãŠé‡‘ã®å¢—ã‚„ã—æ–¹**ã€ã§ã™ã€‚

ã“ã‚Œã¯ã©ã¡ã‚‰ã‹ã£ã¦ã„ã†ã¨ã€ä»Šã¾ã§ç´¹ä»‹ã—ãŸ2å†Šã®æœ¬ã¨ã‹ã«æ¯”ã¹ã¦ã€å‰²ã¨æ”»ã‚ã®ãŠé‡‘ã®ç®¡ç†æ–¹æ³•ã§ã™ã­ã€‚æŠ•è³‡ã¨ã‹æ ªã¨ã‹ã€ç§ã“ã®è¾ºã®ã“ã¨ãŒçµæ§‹ç–ãã¦ã€åˆ†ã‹ã‚Šã‚„ã™ã„æœ¬ãªã„ã‹ãªã¨æ€ã£ãŸæ™‚ã«ã€ãƒªãƒªãƒ¼ãƒŠã•ã‚“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§è¦‹ã¦ãŸã‚“ã§ã™ãŒã€æœ¬ãŒå‡ºã¦ã€ã‚‚ã£ã¨ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã—ãŸæœ¬ã‚‚ã‚ã‚‹ã¿ãŸã„ã§ã™ã€‚

ç§ã¯æ¯å›ã‚„ã‚ã†ã‚„ã‚ã†ã¨æ€ã£ã¦ã„ãŸã€iDeCoã®è©±ãŒã‚ã‚‹ã‚“ã§ã™ãŒã€ãã®iDeCoã®ä»•çµ„ã¿ã€å®Ÿéš›ã«ã©ã†ã„ã†ã‚‚ã®ãªã®ã‹ã£ã¦ã„ã†ã®ã¨ã‹ã€ãã†ã„ã†æ™®é€šã«æ¥½å¤©ã§æŠ•è³‡ä¿¡è¨—ã‚’å§‹ã‚ã‚‹æ–¹æ³•ã‚‚ã‚ã£ãŸã‹ãªã€ãã†ã„ã†ã®ã¨ã‹ã€ã¡ã‚‡ã£ã¨ãµã‚‹ã•ã¨ç´ç¨ã®ã“ã¨ã‚‚æ›¸ã„ã¦ã‚ã‚Šã¾ã™ã­ã€‚

ã ã‹ã‚‰å…¨ç„¶ãã“ã§ã‚ˆãåˆ†ã‹ã‚‰ãªãã¦ã€ã§ããªã‹ã£ãŸã€ãªã‚“ã‹å–ã‚Šçµ„ã‚ãªã„ã¨ã‹ã€æ€–ã„ã¨æ€ã†ã¿ãŸã„ãªã€ã“ã®æœ¬ã‚’èª­ã‚“ã§è¦‹ã¦ã€ã“ã‚Œã ã£ãŸã‚‰ã§ããã†ã ãªã¨æ€ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

---------------

ã€ŒãŠé‡‘ã®ä¸å®‰ã‚¼ãƒ­ãƒ¡ã‚½ãƒƒãƒ‰ã€ã§ãŠé‡‘ã®ä¸å®‰ã‚’å–ã‚Šé™¤ã„ã¦ã€å®‰å¿ƒã§ãã‚‹çŠ¶æ…‹ã«ã—ã¦ãŠãã€‚ã€Œä½ã‚³ã‚¹ãƒˆãƒ©ã‚¤ãƒ•ã€ã§å®Ÿéš›ã«ãŠé‡‘ã‚’ã‹ã‘ãªã„ã§ã§ãã‚‹ã“ã¨ã¨ã‹ã€ãŠé‡‘ã®ä½¿ã„æ–¹ã®å„ªå…ˆé †ä½ã¨ã‹ã€ãã†ã„ã†ã®ã‚’èº«ã«ã¤ã‘ã‚‹ã¨ã‹ã€è‡ªåˆ†ã®ç”Ÿæ´»ã®ä¸­ã§ã§ãã‚‹ã“ã¨ã‚’æ¢ã—ã¦ã„ãã€‚ãã—ã¦ã€ãƒªãƒªãƒ¼ãƒŠã•ã‚“ã®ã€Œåˆå¿ƒè€…ã«å„ªã—ã„ãŠé‡‘ã®å¢—ã‚„ã—æ–¹ã€ã§ã€æŠ•è³‡ã¨ã‹ãµã‚‹ã•ã¨ç´ç¨ã¨ã‹ã€ãã†ã„ã†ã“ã¨ã¨ã‹æ–°ã—ã„çŸ¥è­˜ã‚‚å…¥ã‚ŒãªãŒã‚‰ã€è‡ªåˆ†ã«ã§ãã‚‹ã“ã¨ã‚’æ¢ã™ã¿ãŸã„ãªã€‚

ã“ã®3å†Šã‚’ã“ã®é †ç•ªã§èª­ã‚€ã®ãŒã€ç§ã¯ã„ã„ã‹ãªã¨ã„ã†ãµã†ã«æ€ã„ã¾ã™ã€‚

è‡ªåˆ†ã®ãã®æ™‚ãã®æ™‚ã®ãŠé‡‘ã®ä¸å®‰ã¨ã‹ã€ãŠé‡‘ã«é–¢ã—ã¦ã„ã‚ã„ã‚è€ƒãˆãŸã‚Šæ‚©ã‚“ã ã‚Šã™ã‚‹ã“ã¨ãŒã‚ã£ãŸæ™‚ã«ã€ãã®æœ¬ã‚’ã‚‚ã†ä¸€å›æ‰‹ã«å–ã£ã¦ã€ã€Œã“ã®è¾ºã«ç¢ºã‹æ›¸ã„ã¦ã‚ã£ãŸæ°—ãŒã™ã‚‹ãªã€ã¿ãŸã„ãªæ„Ÿã˜ã§ã€ç§ã¯çµæ§‹å¾©ç¿’ã™ã‚‹å½¢ã§èª­ã¿è¿”ã—ã¾ã™ã€‚

ãŠé‡‘ã®ä¸å®‰ã£ã¦ã„ã†ã®ã¯ã€å®Œå…¨ã«ãªããªã‚‹ã“ã¨ã¯ãªã„ã—ã€ãŸã ã€ä½•ã¦è¨€ã†ã‹ãªã€å¤šåˆ†ã„ãã‚‰ãŠé‡‘ãŒã‚ã£ã¦ã‚‚ã¤ããªã„ã‚“ã§ã™ã‚ˆã­ã€‚ä»Šã‹ã‚‰ç§ã®åå…¥ãŒ10å€ã€100å€ã€1000å€ã¨ã‹ã«ä¸ŠãŒã£ãŸã¨ã—ã¦ã‚‚ã€æœ¬å½“ã«ãã®ã€ŒãŠé‡‘ã‚’å¤±ã†ã€ã£ã¦ã„ã†ä¸å®‰ãŒå‡ºã¦ãã‚‹ã ã‚ã†ã—ã€ã ã‹ã‚‰ã€ŒãŠé‡‘ãŒã‚ã‚Œã°è§£æ±ºã™ã‚‹ã€ã£ã¦æœ¬å½“ã«ãã†ã‹ãªã£ã¦ã„ã†ãµã†ã«ç«‹ã¡æ­¢ã¾ã‚‹ã“ã¨ã®å¤§åˆ‡ã•ã£ã¦ã„ã†ã®ã¯ã‚ã‚‹ã¨æ€ã†ã‚“ã§ã™ã‚ˆã­ã€‚

ã ã‹ã‚‰ã€ã¾ãšã¯ä¸å®‰ã‚’å–ã‚Šé™¤ã„ã¦ã€è‡ªåˆ†ãŒè¡Œå‹•ã—ãŸã‚Šè€ƒãˆã‚‰ã‚ŒãŸã‚Šã™ã‚‹çŠ¶æ…‹ã«æŒã£ã¦ã„ãã€‚ãã“ã‹ã‚‰ã€è‡ªåˆ†ãŒæ¬¡ã«è¡Œå‹•ã§ãã‚‹ã‚ˆã†ãªç²¾ç¥çŠ¶æ…‹ã«æŒã£ã¦ã„ãã£ã¦ã„ã†ã“ã¨ãŒå¤§äº‹ã ã¨æ€ã„ã¾ã™ã€‚

ãŠé‡‘ã®ã“ã¨ã§ã€ã¡ã‚‡ã£ã¨å¿ƒé…ã«ãªã£ãŸã‚Šã§ããŸã‚Šã€ä½•ã‹ä¸å®‰ã«ãªã£ãŸã‚Šã€ä»Šã®ç§ã®ç¨¼ãã§å¤§ä¸ˆå¤«ãªã®ã‹ãªã¨ã‹æ€ã£ãŸæ™‚ã«ã€ä»Šå›ç´¹ä»‹ã—ãŸ3å†Šã‚’èª­ã¿è¿”ã—ãªãŒã‚‰ã€ã¾ãŸæ€ã„å‡ºã™ã¨ã„ã†ã“ã¨ã‚’ã‚„ã£ã¦ã„ã¾ã™ã€‚çš†ã•ã‚“ã‚‚ã‚ˆã‹ã£ãŸã‚‰å‚è€ƒã«ã—ã¦ã¿ã¦ãã ã•ã„ã€‚"""
        
        return article
    
    def generate_general_article_template(self, transcript: str) -> str:
        """ä¸€èˆ¬è¨˜äº‹ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ"""
        return """ãƒãƒŠãƒŸã§ã™ã€‚

ä»Šå›ã¯éŸ³å£°é…ä¿¡ã®å†…å®¹ã«ã¤ã„ã¦ãŠè©±ã—ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

æœ€è¿‘æ„Ÿã˜ã¦ã„ã‚‹ã“ã¨ã‚’ãŠè©±ã—ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

---------------

ã„ã‚ã„ã‚ãªç™ºè¦‹ãŒã‚ã‚Šã€çš†ã•ã‚“ã¨å…±æœ‰ã—ã¦ã„ããŸã„ã¨æ€ã£ã¦ã„ã¾ã™ã€‚

ä»Šå¾Œã‚‚ã“ã†ã—ãŸå†…å®¹ã‚’çš†ã•ã‚“ã¨å…±æœ‰ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚"""

    def process_audio_file(self, audio_path: str):
        """éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†ã—ã¦è¨˜äº‹ã‚’ç”Ÿæˆ"""
        filename = Path(audio_path).name
        
        # å‰å›ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨ã‚¯ãƒªã‚¢
        self.cleanup_previous_session()
        
        print(f"\\nğŸµ æ–‡å­—èµ·ã“ã—ä¸­...")
        
        # æ–‡å­—èµ·ã“ã—
        transcript = self.transcribe_with_whisper(audio_path)
        
        if not transcript:
            print("âŒ æ–‡å­—èµ·ã“ã—ã«å¤±æ•—ã—ã¾ã—ãŸ")
            return
        
        # ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
        self.current_audio_name = filename
        self.previous_transcript = transcript
        
        print(f"ğŸ¤– è¨˜äº‹ç”Ÿæˆä¸­...")
        
        # é«˜å“è³ªè¨˜äº‹ç”Ÿæˆ
        article = self.generate_high_quality_article(transcript)
        
        # ç”Ÿæˆã—ãŸè¨˜äº‹ã‚’ä¿å­˜
        self.previous_article = article
        
        print(f"âœ… å‡¦ç†å®Œäº†\\n")
        
        # çµæœè¡¨ç¤º
        self.display_results(article)

    def display_results(self, article: str):
        """çµæœã‚’è¡¨ç¤º"""
        # è¨˜äº‹ã‚’ç›´æ¥è¡¨ç¤º
        print("=" * 80)
        print("ğŸ“° ç”Ÿæˆã•ã‚ŒãŸè¨˜äº‹:")
        print("=" * 80)
        print(article)
        print("=" * 80)
        
        # ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
        try:
            pyperclip.copy(article)
            print("\\nâœ… è¨˜äº‹ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ä¿å­˜ã—ã¾ã—ãŸï¼")
        except Exception as e:
            print(f"âš ï¸ ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ä¿å­˜ã«å¤±æ•—: {e}")

    def print_banner(self):
        """ãƒãƒŠãƒ¼è¡¨ç¤º"""
        print("ğŸ™ï¸" + "=" * 60)
        print("    é«˜å“è³ªè¨˜äº‹ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ ")
        print("    ğŸ’° å®Œç’§ãªè¨˜äº‹ã‚’è‡ªå‹•ç”Ÿæˆ")
        print("=" * 62)
        print()

    def main(self):
        """ãƒ¡ã‚¤ãƒ³å‡¦ç†"""
        parser = argparse.ArgumentParser(description='é«˜å“è³ªè¨˜äº‹ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ ')
        parser.add_argument('audio_file', nargs='?', help='éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹')
        parser.add_argument('--model', choices=['tiny', 'base', 'small', 'medium', 'large'], 
                          default='tiny', help='Whisperãƒ¢ãƒ‡ãƒ«ã‚’æŒ‡å®š')
        
        args = parser.parse_args()
        
        # ãƒ¢ãƒ‡ãƒ«æŒ‡å®šãŒã‚ã‚Œã°è¨­å®š
        if args.model:
            self.model_name = args.model
        
        self.print_banner()
        
        print("ğŸ’¡ ä½¿ç”¨æ–¹æ³•:")
        print("   1. ğŸ“ éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã«ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦Enter")
        print("   2. ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’ç›´æ¥å…¥åŠ›")
        print()
        
        # ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ã§éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆ
        if args.audio_file:
            audio_path = args.audio_file.strip().strip('"').strip("'")
            audio_path = os.path.expanduser(audio_path)
            
            if os.path.exists(audio_path):
                self.process_audio_file(audio_path)
            else:
                print(f"âŒ ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: {audio_path}")
            return
        
        # ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãƒ¢ãƒ¼ãƒ‰
        while True:
            print("ğŸ¯ éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã™ã‚‹ã‹ã€ãƒ‘ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„")
            print("   (çµ‚äº†ã™ã‚‹ã«ã¯ 'q' ã‚’å…¥åŠ›)")
            audio_input = input("ğŸ™ï¸ ãƒ•ã‚¡ã‚¤ãƒ«: ").strip()
            
            if audio_input.lower() in ['q', 'quit', 'exit']:
                break
            
            if not audio_input:
                continue
            
            # ãƒ‘ã‚¹ã®æ•´ç†ï¼ˆãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—å¯¾å¿œï¼‰
            audio_path = audio_input.strip()
            
            # ã‚¯ã‚ªãƒ¼ãƒˆæ–‡å­—ã‚’å‰Šé™¤
            if audio_path.startswith('"') and audio_path.endswith('"'):
                audio_path = audio_path[1:-1]
            elif audio_path.startswith("'") and audio_path.endswith("'"):
                audio_path = audio_path[1:-1]
            
            # å…¨ã¦ã®ãƒãƒƒã‚¯ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚’å‡¦ç†
            audio_path = audio_path.replace('\\ ', ' ')
            audio_path = audio_path.replace('\\~', '~')
            audio_path = audio_path.replace('\\\\', '\\')
            
            # ãƒãƒ«ãƒ€å±•é–‹
            audio_path = os.path.expanduser(audio_path)
            
            print(f"ğŸ” å‡¦ç†é–‹å§‹: {os.path.basename(audio_path)}")
            
            if os.path.exists(audio_path):
                self.process_audio_file(audio_path)
            else:
                print(f"âŒ ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
                continue
            
            # æ¬¡ã®å‡¦ç†ã‚’ç¢ºèª
            print("\\n" + "=" * 60)
            next_action = input("ğŸ”„ åˆ¥ã®éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†ã—ã¾ã™ã‹ï¼Ÿ (y/N): ").lower().strip()
            if next_action not in ['y', 'yes']:
                break
        
        print("ğŸ‘‹ ãŠç–²ã‚Œã•ã¾ã§ã—ãŸï¼")

if __name__ == "__main__":
    generator = ImprovedArticleGenerator()
    generator.main()